<!DOCTYPE html>
<html lang="es">
<head>
    {% load static %}
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
    <title>Graficar — Límites</title>

    <link rel="stylesheet" href="{% static 'css/graficar_limites.css' %}?v=1.2">

    <style>
      /* SIDEBAR / ASIDE */
      aside.form-aside {
        height: 82vh; /* deja espacio para header */
        position: sticky;
        top: 8vh;
        padding: 1rem;
        background: #fff;
        border-radius: .5rem;
        box-shadow: 0 6px 18px rgba(0,0,0,.04);
        overflow-y: auto;
      }

      .aside-top {
        display:flex;
        gap:.5rem;
        align-items:center;
        justify-content:space-between;
        margin-bottom:.75rem;
      }

      .boton {
        border-radius: 100%;
        border: 2px solid rgb(113, 203, 255);
        width: 40px;
        height: 40px;
        font-size: 20px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
      }

      .add-btn {
        display:inline-flex;
        align-items:center;
        gap:.35rem;
      }

      #inputs-container .input-row {
        display:flex;
        gap:.5rem;
        align-items:flex-start;
        margin-bottom:.6rem;
      }

      .input-row .input-container {
        flex: 1 1 auto;
        display:flex;
        flex-direction:column;
      }

      .input-row .input-container input {
        padding:.45rem .6rem;
        border-radius:.35rem;
        border:1px solid #dfe6ef;
      }

      .remove-btn {
        border: none;
        background: transparent;
        color: #d6333f;
        font-size: 18px;
        cursor: pointer;
        padding: .15rem .4rem;
        line-height: 1;
        align-self:center;
      }

      .submit-row {
        display:flex;
        gap:.5rem;
        align-items:center;
        margin-top: .75rem;
      }

      /* móvil: aside ocupa toda la fila arriba del plot */
      @media (max-width: 767px) {
        aside.form-aside {
          position: static;
          height: auto;
          margin-bottom: 1rem;
        }
      }
    </style>
</head>
<body>
  <header>
    <div class="container">
      <div class="row">
        <div class="col">
          {% include 'nav.html' %}
        </div>
      </div>
    </div>
  </header>

  <main class="py-4">
    <div class="container">
      <div class="row gx-4">
        <!-- ASIDE: formulario (mejorado) -->
        <aside class="col-lg-3 col-md-4 mb-3">
          <aside class="form-aside" aria-labelledby="aside-title">
            <div class="aside-top">
              <h6 id="aside-title" class="mb-0">Funciones</h6>

              <!-- Botón + -->
              <button id="newfuncion" type="button" class="btn btn-sm btn-outline-primary boton" title="Agregar función" aria-label="Agregar función">
                <i class="bi bi-plus-lg" aria-hidden="true"></i>
              </button>
            </div>

            <form id="form_functions" method="post" action="{% url 'limites' %}" class="function-form" novalidate>
              {% csrf_token %}

              <!-- Contenedor de inputs dinámicos -->
              <div id="inputs-container" aria-live="polite">
                <!-- FILA BASE: par (función, c) -->
                <div class="input-row" data-row-index="0">
                  <div class="input-container">
                    <label class="form-label visually-hidden" for="funcion-0">Función</label>
                    <input required id="funcion-0" type="text" name="funcion[]" placeholder="ej. sin(x)/x" aria-label="Función" />
                  </div>

                  <div class="input-container" style="max-width:110px;">
                    <label class="form-label visually-hidden" for="c-0">c</label>
                    <input id="c-0" type="text" name="c[]" value="0" placeholder="c" aria-label="Valor de c" />
                  </div>

                  <!-- El primer row puede tener botón X, opcional -->
                  <button type="button" class="remove-btn" title="Eliminar esta función" aria-label="Eliminar función">
                    <i class="bi bi-x-lg"></i>
                  </button>
                </div>
              </div>

              <!-- Acciones -->
              <div class="submit-row">
                <button type="submit" class="btn btn-primary w-100">
                  <i class="bi bi-calculator me-1"></i> Calcular límites
                </button>
              </div>

              <small class="text-muted d-block mt-2">Puedes agregar varias funciones :)</small>
            </form>
          </aside>
        </aside>

        <!-- MAIN content: gráfico y resultados -->
        <section class="col-lg-9 col-md-8">
          <div class="card p-3">
            <h5 class="mb-1">Resultados</h5>

            {% if resultados %}
              <ul class="list-group mb-2">
                {% for r in resultados %}
                  <li class="list-group-item">
                    <div class="d-flex justify-content-between align-items-start">
                      <div>
                        <strong>{{ r.funcion }}</strong>
                        <div class="small text-muted">c = {{ r.c }}</div>
                        <div>límite: <strong>{{ r.limite|default:"No disponible" }}</strong></div>
                        {% if r.error %}
                          <div class="text-danger small">Error: {{ r.error }}</div>
                        {% endif %}
                      </div>
                      <div class="text-end small">
                        {% if r.limite %}
                          <span class="badge bg-success">Límite calculado</span>
                        {% endif %}
                      </div>
                    </div>
                  </li>
                {% endfor %}
              </ul>
            {% else %}
              <p class="text-muted">No hay resultados aún. Introduce una o más funciones y pulsa "Calcular límites".</p>
            {% endif %}

            <div id="plotly-div" style="height:500px;"></div>
          </div>
        </section>
      </div>
    </div>
  </main>

  <!-- Plotly -->
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>

  {# Exportar resultados completos como JSON de forma segura #}
  {% if resultados %}
    {{ resultados|json_script:"resultados-data" }}
  {% endif %}

  <!-- Script para añadir/eliminar inputs y graficar múltiples funciones -->
  <script>
  (function () {
    // ===== inputs dinámicos =====
    let nextIndex = 1; // ya existe el índice 0
    const addBtn = document.getElementById('newfuncion');
    const container = document.getElementById('inputs-container');

    // delegación para eliminar (también cubre el primer botón X)
    container.addEventListener('click', function(e) {
      const btn = e.target.closest('.remove-btn, .remove-btn *');
      if (!btn) return;
      const row = btn.closest('.input-row');
      if (!row) return;

      // si solo queda un input-row, limpiar en vez de eliminar
      const rows = container.querySelectorAll('.input-row');
      if (rows.length <= 1) {
        row.querySelectorAll('input').forEach(i => i.value = '');
      } else {
        row.remove();
      }
    });

    addBtn.addEventListener('click', function () {
      const row = document.createElement('div');
      row.className = 'input-row';
      row.dataset.rowIndex = nextIndex;

      row.innerHTML = `
        <div class="input-container">
          <label class="form-label visually-hidden" for="funcion-${nextIndex}">Función</label>
          <input required id="funcion-${nextIndex}" type="text" name="funcion[]" placeholder="ej. x**2+1" aria-label="Función" />
        </div>

        <div class="input-container" style="max-width:110px;">
          <label class="form-label visually-hidden" for="c-${nextIndex}">c</label>
          <input id="c-${nextIndex}" type="text" name="c[]" value="0" placeholder="c" aria-label="Valor de c" />
        </div>

        <button type="button" class="remove-btn" title="Eliminar esta función" aria-label="Eliminar función">
          <i class="bi bi-x-lg"></i>
        </button>
      `;

      container.appendChild(row);
      row.querySelector('input').focus();
      nextIndex++;
    });

    // ===== Plotly: graficar los resultados exportados por json_script =====
    try {
      const resultadosElem = document.getElementById('resultados-data');
      if (resultadosElem) {
        let resultados = [];
        try {
          resultados = JSON.parse(resultadosElem.textContent || '[]');
        } catch (e) {
          console.error('No se pudo parsear resultados-data:', e);
          resultados = [];
        }

        const traces = [];
        resultados.forEach((r, idx) => {
          let xs = r.x_json;
          let ys = r.y_json;

          // si vinieron como strings JSON (por seguridad), intentar parsear
          if (typeof xs === 'string') {
            try { xs = JSON.parse(xs); } catch(e) { xs = null; }
          }
          if (typeof ys === 'string') {
            try { ys = JSON.parse(ys); } catch(e) { ys = null; }
          }

          if (!Array.isArray(xs) || !Array.isArray(ys) || xs.length !== ys.length) {
            console.warn('Datos inválidos para la función:', r.funcion);
            return;
          }

          traces.push({
            x: xs,
            y: ys,
            mode: 'lines',
            name: r.funcion || `f${idx+1}(x)`,
            line: { width: 2 }
          });

          // marcar aproximación en c (primer y finito cercano)
          const cval = parseFloat(r.c);
          if (!Number.isNaN(cval)) {
            let nearestY = null;
            for (let i = 0; i < xs.length; i++) {
              if (ys[i] !== null && ys[i] !== undefined && !isNaN(ys[i]) && isFinite(ys[i])) {
                nearestY = ys[i];
                break;
              }
            }
            if (nearestY !== null) {
              traces.push({
                x: [cval],
                y: [nearestY],
                mode: 'markers',
                name: `c (${r.funcion})`,
                marker: { size: 8, symbol: 'circle' }
              });
            }
          }
        });

        const plotEl = document.getElementById('plotly-div');
        if (plotEl) {
          if (traces.length > 0) {
            const layout = {
              title: 'Gráficas de funciones',
              xaxis: { title: 'x' },
              yaxis: { title: 'f(x)', autorange: true },
              showlegend: true,
              margin: { t: 40, b: 40 }
            };
            Plotly.newPlot(plotEl, traces, layout, { responsive: true });
          } else {
            plotEl.innerHTML = '<p class="text-muted">No hay funciones válidas para graficar.</p>';
          }
        }
      }
    } catch (err) {
      console.error("Error al inicializar la gráfica:", err);
    }
  })();
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
